SPA.ClientSide=function(w){function L(d,e){if("string"===typeof e){var f=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})\.(\d{3})Z$/.exec(e);if(f)return new Date(Date.UTC(+f[1],+f[2]-1,+f[3],+f[4],+f[5],+f[6],+f[7]))}return e}var x=window,r={},t=[],A=0,m=SPA,I="Ok;Bad Json Request;Bad number of arguments;Bad arguments;Bad argument type;Bad request;Empty request;Not supported;Authentication failed".split(";");(function(d,e,f,m){d.addEventListener?d.addEventListener(e,f,m):d.attachEvent&&(d["e"+e+
f]=f,d[e+f]=function(){d["e"+e+f](x.event)},d.attachEvent("on"+e,d[e+f]))})(x,"unload",function(d){for(d=t.length-1;0<=d;--d){var e=t[d];e&&e.isOpen()&&e.close()}t=[]},!1);r.count=function(){return t.length};r.host=function(d){d&&"string"==typeof d&&(w=d);return w};r.version=function(){return 1.2};r.jsCallback=function(d){if(d){var e,f=t.length;for(e=0;e<f&&!t[e].jsCallback(d);++e);}};r.connect=function(d,e,f,r,p){function x(a){if(a)try{J.removeChild(a)}catch(b){}}function E(a){m.log("JavaScript error = "+
a);if(c&&"function"==typeof c.onError)c.onError(a)}function F(a){a&&x(a);a=document.createElement("script");a.setAttribute("type","text/javascript");a.setAttribute("charset","utf-8");return a}function G(a,b){b=encodeURIComponent(b);a.setAttribute("src",w+p+"?UJS_DATA="+b);a.setAttribute("charset","utf-8");J.appendChild(a)}function H(){r&&(r(),r=null);m.log("Javascript closed");a:{var a=c,b,h=t.length;for(b=0;b<h;++b)if(t[b]===a){t.splice(b,1);break a}}u=[];q=[];B=0;x(l);l=null}function K(a){var b,
c,d=q.length;for(c=0;c<d;++c)if(q[c].i==a){b=q[c];q.splice(c,1);break}return b}var k,y=0,B=0,l=null,c={},n=0,q=[],u=[],J=document.body,z=new Date,C=m.debug()?805306367:3E4,v="",D=4E3,g={b:0,rb:[]};"string"!=typeof p&&(p="");p=p.replace(/^\s+|\s+$/g,"");p.indexOf("/")||(p=p.substr(1));m.log("Javascript connecting to "+w+p+" ......");c.isBatching=function(){return!!g.b};c.getBatchSize=function(){return JSON.stringify(g).length-15};c.beginBatching=function(){if(!l)throw"Javascript connection closed!";
g.b=1};c.commit=function(a){if(!l)throw"Javascript connection closed!";g.b=0;g.rb.length&&(c.sendRequest("udoBatch",!!a,g.rb),g.rb=[]);return n};c.rollback=function(){if(!l)throw"Javascript connection closed!";var a,b=g.rb.length;for(a=0;a<b;++a)K(g.rb[a].i);g.rb=[];g.b=0};c.msg=function(){return k};c.channel=function(){return p};c.jsCallback=function(a){var b,h,d,e=[];z=new Date;a.rb?e=a.rb:e.push(a);d=e.length;for(a=0;a<d;++a){k=JSON.parse(JSON.stringify(e[a]),L);if(k.rc){E(I[k.rc]);H();break}if(k.i)--y,
b=K(k.i),k.n=b.m,m.log("Result <<"+JSON.stringify(k)+">> returned for call index = "+k.i),b=b?b.cb:null,B||(B=1,m.log("Javascript connected to "+w+p),k.rc?(v="",E(I[k.rc])):(v=k.id,D=k.pt,f&&f()),f=null),b&&b(k),u.length&&!y&&(b=u[0],y="udoBatch"==b.n?b.a[1].length:1,u.splice(0,1),l=F(l),h=JSON.stringify(b),m.log("Request <<"+h+">> dequeued and sent with call index = "+b.i),G(l,h));else if(m.log("Result <<"+JSON.stringify(k)+">> returned"),"function"==typeof c.push.onMessage)c.push.onMessage(k)}};
c.close=function(){C=1E3;c.isOpen()&&(c.sendRequest("uclose",function(a){H()}),v="")};c.isOpen=function(){return!!l&&!!B&&17<v.length};c.script=function(){return l};c.userId=function(){return d};c.cancel=function(){if(g.b)throw"Bad operation -- batching requests";var a={aborted:u.length,ignored:q.length-u.length};q=[];u=[];return a};c.count=function(){return q.length+u.length};c.callIndex=function(){return n};c.timeout=function(a){"number"==typeof a&&1E3<=a&&(C=a);return C};c.pingTime=function(a){"number"==
typeof a&&1E3<=a&&59E3>=a&&(D=a);return D};c.sendRequest=function(){if(!c.isOpen())throw"Javascript connection closed!";c.count()||(l=F(l));n=++A;var a,b,h,d=Array.prototype.slice.call(arguments),e=d.length;if(1>e)throw"Valid request name required";h=d[0];if(!h||"string"!=typeof h)throw"Valid request name required";if(!/^([a-zA-Z_][\w]*)$/.exec(h))throw"Valid request name required";b={n:h,i:A,v:1.2,id:v};d.splice(0,1);--e;var f={m:h,i:A};e&&"function"==typeof d[e-1]&&(a=d[e-1],d.splice(e-1,1),f.cb=
a);"udoBatch"!=h&&q.push(f);b.a=d;if(g.b&&"uping"!=h)return g.rb.push(b),m.log("Request "+h+" batched with call index = "+n),z=new Date,n;2>q.length-g.rb.length?(y="udoBatch"!=h?1:d[1].length,b=JSON.stringify(b),z=new Date,m.log("Request <<"+b+">> sent with call index = "+n),G(l,b)):(m.log("Request "+h+" queued with call index = "+n),u.push(b));return n};c.push=function(){function a(a){if("object"!=typeof a||!a.sort)throw"Invalid chat groups";for(var b=0;b<a.length;++b){var c=parseInt(a[b]);c?a[b]=
c:(a.splice(b,1),--b)}}return{ws:function(){return c},speak:function(b,d,e){a(d);return c.sendRequest("uspeak",b,d,e)},sendUserMessage:function(a,d,e){return c.sendRequest("usendUserMessage",d,a,e)},enter:function(b,e){a(b);return c.sendRequest("uenter",b,d,e)},exit:function(a){return c.sendRequest("uexit",a)}}}();t.push(c);l=F();n=++A;q.push({m:"uswitchTo",i:n});y=1;G(l,JSON.stringify({n:"uswitchTo",i:n,v:1.2,id:v,a:[d,e]}));m.log("Request uswitchTo sent with call index = "+n);setInterval(function(a){a=
new Date;var b=a.getTime()-z.getTime();c.count()?b>C&&(E("Communication timed out"),c.close(),H()):c.isOpen()&&b>D&&(z=a,a=g.b,g.b=0,c.sendRequest("uping",function(a){}),g.b=a)},400);return c};return r}