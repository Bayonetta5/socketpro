SPA.ClientSide=function(w){function E(b){var e,d=u.length;for(e=0;e<d;++e)if(u[e]===b){u.splice(e,1);l.log("WebSocket closed");break}}function H(b,e){if("string"===typeof e){var d=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})\.(\d{3})Z$/.exec(e);if(d)return new Date(Date.UTC(+d[1],+d[2]-1,+d[3],+d[4],+d[5],+d[6],+d[7]))}return e}var F=window,r={},u=[],C=0,l=SPA,G="Ok;Bad Json Request;Bad number of arguments;Bad arguments;Bad argument type;Bad request;Empty request;Not supported;Authentication failed".split(";");
(function(b,e,d,l){b.addEventListener?b.addEventListener(e,d,l):b.attachEvent&&(b["e"+e+d]=d,b[e+d]=function(){b["e"+e+d](F.event)},b.attachEvent("on"+e,b[e+d]))})(F,"unload",function(b){u=[]},!1);r.count=function(){return u.length};r.host=function(b){b&&"string"==typeof b&&(w=b);return w};r.version=function(){return 1.2};r.connect=function(b,e,d,v,n){function r(h){var c,a,b=p.length;for(a=0;a<b;++a)if(p[a].i==h){c=p[a];p.splice(a,1);break}return c}function y(h){l.log("WebSocket error = "+h);if(f&&
"function"==typeof a.onError)a.onError(h)}"string"!=typeof n&&(n="");var z="",D=l.debug()?805306367:3E4,x=6E4,g={b:0,rb:[]};n=n.replace(/^\s+|\s+$/g,"");var A=new Date;n.indexOf("/")||(n=n.substr(1));var B,m,f=new WebSocket(w+n,"uhttprequest"),a={},t=0,p=[],q=[];l.log("WebSocket connecting to "+w+n+" ......");f.onopen=function(h){a.sendRequest("uswitchTo",b,e,function(a){B=1;l.log("Connected to "+w+n);a.rc?(z="",y(G[a.rc])):(z=a.id,x=a.pt,d&&d())})};f.onclose=function(h){B=0;v&&(v(),v=null);E(a);
f=null;q=[];p=[]};f.onerror=function(a){y(a.toString())};f.onmessage=function(h){if(null!=f)if(A=new Date,m=h.data,m=JSON.parse(m,H),m.rc)y(G[m.rc]),a.close();else{h=!m.i;if(!h){if(q.length){var c,k=q[0];q.splice(0,1);c=JSON.stringify(k);f.send(c);l.log("Request <<"+c+">> dequeued and sent with call index = "+k.i)}(c=r(m.i))?(m.n=c.m,c.cb&&c.cb(m)):h=1}if(h&&"function"==typeof a.push.onMessage)a.push.onMessage(m);l.log("Result <<"+JSON.stringify(m)+">> returned")}};a.isBatching=function(){return!!g.b};
a.getBatchSize=function(){return JSON.stringify(g).length-15};a.beginBatching=function(){if(!f)throw"Web socket closed!";g.b=1};a.commit=function(h){if(!f)throw"Web socket closed!";g.b=0;g.rb.length&&(a.sendRequest("udoBatch",!!h,g.rb),g.rb=[]);return t};a.rollback=function(){if(!f)throw"Web socket closed!";var a,c=g.rb.length;for(a=0;a<c;++a)r(g.rb[a].i);g.rb=[];g.b=0};a.msg=function(){return m};a.channel=function(){return n};a.close=function(){B=0;f&&(f.close(),f=null,v&&(v(),v=null),E(a));q=[];
p=[];x=6E4;g.b=0};a.isOpen=function(){return!!f&&1==f.readyState&&!!B&&17<z.length};a.script=function(){return f};a.userId=function(){return b};a.cancel=function(){if(g.b)throw"Bad operation -- batching requests";var a={aborted:q.length,ignored:p.length-q.length};p=[];q=[];return a};a.count=function(){return p.length+q.length};a.callIndex=function(){return t};a.timeout=function(a){"number"==typeof a&&1E3<=a&&(D=a);return D};a.pingTime=function(a){"number"==typeof a&&3500<=a&&59E3>=a&&(x=a);return x};
a.sendRequest=function(){if(!f)throw"Web socket closed!";t=++C;var a,c,k,b=Array.prototype.slice.call(arguments),d=b.length;if(1>d)throw"Valid request name required";k=b[0];if(!k||"string"!=typeof k)throw"Valid request name required";if(!/^([a-zA-Z_][\w]*)$/.exec(k))throw"Valid request name required";c={n:k,i:C,v:1.2,id:z};b.splice(0,1);--d;var e={m:k,i:C};d&&"function"==typeof b[d-1]&&(a=b[d-1],b.splice(d-1,1),e.cb=a);"udoBatch"!=k&&p.push(e);c.a=b;if(g.b&&"uping"!=k)return g.rb.push(c),l.log("Request "+
k+" batched with call index = "+t),A=new Date,t;10>p.length-g.rb.length?(c=JSON.stringify(c),f.send(c),l.log("Request <<"+c+">> sent with call index = "+t)):(q.push(c),l.log("Request "+k+" queued with call index = "+t));return t};a.push=function(){function d(a){if("object"!=typeof a||!a.sort)throw"Invalid chat groups";for(var c=0;c<a.length;++c){var b=parseInt(a[c]);b?a[c]=b:(a.splice(c,1),--c)}}return{ws:function(){return a},speak:function(c,b,e){d(b);return a.sendRequest("uspeak",c,b,e)},sendUserMessage:function(c,
b,d){return a.sendRequest("usendUserMessage",b,c,d)},enter:function(c,e){d(c);return a.sendRequest("uenter",c,b,e)},exit:function(c){return a.sendRequest("uexit",c)}}}();u.push(a);setInterval(function(b){b=new Date;var c=b.getTime()-A.getTime();a.count()?c>D&&(y("Communication timed out"),a.close()):a.isOpen()&&c+3E3>x&&(A=b,b=g.b,g.b=0,a.sendRequest("uping",function(a){}),g.b=b)},400);return a};return r}