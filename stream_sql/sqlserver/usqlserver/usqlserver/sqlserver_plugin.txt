
Create database sp_streaming_db
GO

EXEC sp_changedbowner 'sa' ALTER DATABASE sp_streaming_db SET TRUSTWORTHY ON
GO

USE sp_streaming_db
GO

-- set initial table config for configuration
CREATE TABLE config(mykey nvarchar(32)primary key,value nvarchar(max)not null)
GO
INSERT INTO config VALUES('disable_ipv6','0')
GO
INSERT INTO config VALUES('main_threads','1')
GO
INSERT INTO config VALUES('enable_http_websocket','0')
GO
INSERT INTO config VALUES('port','20903')
GO
INSERT INTO config VALUES('services','')
GO
INSERT INTO config VALUES('store_or_pfx','')
GO
INSERT INTO config VALUES('subject_or_password','')
GO
INSERT INTO config VALUES('read_only','1')
GO
INSERT INTO config VALUES('working_directory','C:\ProgramData\\MSSQL\')
GO

sp_configure 'clr enabled', 1
GO

RECONFIGURE
GO

-- Load usqlserver.dll into SQL server
CREATE ASSEMBLY usqlserver
AUTHORIZATION [dbo]
FROM 'C:\my_directory\usqlserver.dll' -- make sure the path to usqlserver.dll is correct!
WITH PERMISSION_SET = UNSAFE
GO


CREATE FUNCTION StartSPServer()
returns int
As
	EXTERNAL NAME usqlserver.SQLPlugin.StartSPServer
GO

CREATE FUNCTION  StopSPServer()
returns int
As
	EXTERNAL NAME usqlserver.SQLPlugin.StopSPServer
GO	

CREATE TRIGGER start_sp_server
ON ALL SERVER
FOR LOGON
AS
BEGIN
	if sp_streaming_db.dbo.StartSPServer() < 0
	BEGIN
		ROLLBACK;
	END
END
GO


-- CREATE TRIGGER tr_config ON config AFTER INSERT,DELETE,UPDATE AS EXTERNAL NAME usqlserver.SQLPlugin.PublishDBEvent

select sp_streaming_db.dbo.StartSPServer()
GO

-- use cmd and execute the following to check port
-- netstat -a

sqlcmd -S LocalHost -d master -A
DROP TRIGGER start_sp_server ON ALL SERVER
GO
exit